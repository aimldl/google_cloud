# init4hub_vm

# Function definition
run() {
  COMMAND=$1
  echo "$COMMAND"
  eval $COMMAND
}

# https://cloud.google.com/compute/docs/regions-zones
export REGION=${1:-us-central1}
echo "REGION=$REGION"
echo "Setting the associated variables automatically..."

# Handle the rest of the part automatically.
#   You may edit some lines to change the configuration.
export PROJECT_ID=$(gcloud config list --format 'value(core.project)')
if [[ -z "$PROJECT_ID" ]]; then
  echo "PROJECT_ID is empty because the core.project property is not displayed."
  echo "This means that you haven't explicitly set a default project for the gcloud CLI."
  echo "Please set your project by running:"
  echo "  $ gcloud config set project PROJECT_ID"
  echo "To check the PROJECT_ID, go to Google Cloud Console and click Navigation Menu."
  echo "Go to Cloud overview > Dashboard and check Project ID in the Project Info card."
  exit 1
fi

export NETWORK=custom-network-${REGION}
export SUBNET=custom-subnetwork-${REGION}
export SUBNET_RANGE=10.128.0.0/20
# Example: 10.138.0.0/20, 10.132.0.0/20, 10.128.0.0/20

export FIREWALL_NAME_HTTP=allow-http-traffic-${REGION}
export TAG_NAME_HTTP=http-${REGION}
export FIREWALL_NAME_SSH=allow-ssh-traffic-${REGION}
export TAG_NAME_SSH=ssh-${REGION}
export FIREWALL_PRIORITY=1000
# export IP_RANGE=  # optional

export SERVICE_ACCOUNT_NAME=my-service-account
export SECRET_NAME=my-secret
export SERVICE_ACCOUNT_KEY_NAME=my-key.json

echo ""
echo "Creating a network $NETWORK ..."
run "gcloud compute networks create $NETWORK --project $PROJECT_ID --subnet-mode=custom --mtu=1460 --bgp-routing-mode=regional"

echo ""
echo "Creating a subnet $SUBNET for this network ..."
run "gcloud compute networks subnets create $SUBNET \
--project=$PROJECT_ID \
--range=$SUBNET_RANGE \
--network=$NETWORK \
--region=$REGION"

echo ""
echo "Creating firewall rules..."
echo "  to allow HTTP (tcp:80) traffic with a tag (http)"
run "gcloud compute firewall-rules create $FIREWALL_NAME_HTTP \
--network=$NETWORK \
--target-tags=$TAG_NAME_HTTP \
--allow=tcp:80 \
--priority=$FIREWALL_PRIORITY"
# --source-ranges=$IP_RANGE  # optional

echo ""
echo "  to allow SSH (tcp:22) traffic with a tag (ssh)"
run "gcloud compute firewall-rules create $FIREWALL_NAME_SSH \
--network=$NETWORK \
--target-tags=$TAG_NAME_SSH \
--allow=tcp:22 \
--priority=$FIREWALL_PRIORITY"
# --source-ranges=$IP_RANGE  # optional

echo ""
echo "  Creating a service account $SERVICE_ACCOUNT_NAME..."
run "gcloud iam service-accounts create $SERVICE_ACCOUNT_NAME\
    --display-name "My Service Account" \
    --project=$PROJECT_ID"

# Get the service account email.
SERVICE_ACCOUNT_EMAIL=$(gcloud iam service-accounts list \
    --format='value(email)' \
    --project=$PROJECT_ID \
    --filter='displayName:"My Service Account"')
echo $SERVICE_ACCOUNT_EMAIL

echo ""
echo "Creating a secret/service account key $SECRET_NAME and add the key to Secrete Manager ..."
run "gcloud secrets create $SECRET_NAME\
    --replication-policy=automatic \
    --project=$PROJECT_ID"

# TODO:
# Add the service account as an IAM member to the secret.
